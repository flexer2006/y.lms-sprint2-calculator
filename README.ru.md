# Распределенный калькулятор арифметических выражений

## Описание
Это проект распределенного калькулятора, который обрабатывает арифметические выражения. Система состоит из двух основных компонентов: оркестратора и агентов. Служба оркестратора управляет входящими запросами на вычисления и распределяет рабочую нагрузку между несколькими экземплярами агентов. Агенты выполняют фактические арифметические вычисления с настраиваемым временем обработки для различных операций (сложение, вычитание, умножение, деление).

## Возможности

На основе тестовых файлов и реализации этот калькулятор обладает следующими возможностями:

1. Арифметические операции: Базовые операции: сложение ( + ), вычитание ( - ), умножение ( * ), деление ( / ), обработка десятичных чисел с высокой точностью, Поддержка очень больших и очень маленьких чисел, правильная обработка приоритета операторов.
2. Функции выражений: Поддержка скобок для вложенных выражений: (2 + 3) * (4 + 5), унарный оператор минус в разных контекстах (-2, 2 * -3), несколько операций в одном выражении, сложные вложенные выражения, гибкая обработка пробелов.
3. Проверка ввода: Проверка пустых выражений, проверка сбалансированных скобок, проверка использования десятичной точки, предотвращение недопустимых символов, проверка последовательных операторов, проверка отсутствующих операндов/операторов, защита от деления на ноль.
4. Распределенная обработка: Параллельная обработка вычислений, распределение задач по нескольким агенты, конфигурация времени работы для различных операций, ведение журнала запросов/ответов, обработка ошибок и отслеживание статуса.
5. Дополнительные функции: Отслеживание статуса выражения (ожидание, в процессе, завершено, ошибка), подробный отчет об ошибках, комплексная система журналирования, поддержка длинных выражений, высокоточные десятичные вычисления.

## Использованные технологии

- **Go v1.23.6**
- **Стандартные библиотеки Go**
- **Zap logger v1.27.0**
- **Google генератор UUID v1.6.0**
- **Testify для улучшения тестирования v1.10.0**
- **Роутер HTTP gorilla/mux v1.8.1**
- **Отладочный вывод go-spew v1.1.1**
- **Для вычисления и форматирования разницы между строками - go-difflib v1.0.0**
- **Библиотека для объединения нескольких ошибок в одну - multierr v1.11.0**
- **Библиотека для работы с YAML - yaml.v3 v3.0.1**

## Установка

### Клонируйте репозиторий

 **Используя HTTPS:**
```
git clone https://github.com/flexer2006/y.lms-sprint2-calculator.git
```

**Или используя SSH:**
```
git clone git@github.com:flexer2006/y.lms-sprint2-calculator.git
```

## Запуск 

### Перейдите в каталог проекта:
```
cd y.lms-sprint2-calculator
```

### Метод 1: использовать Docker

**Соберите образы:**
```
docker build -t calculator-orchestrator -f Dockerfile --target orchestrator .
```
```
docker build -t calculator-agent -f Dockerfile --target agent .
```

**Запустите оркестратор:**
```
docker run -d -p 8080:8080 --name orchestrator calculator-orchestrator
```
**Запустите одного или несколько агентов:**
```
docker run -d --name agent1 calculator-agent
```

## Метод 2: использовать Makefile

**Ознакомьтесь с возможными командами:**
```
make help
```
**Соберите оба сервиса:**
```
make build
```
**Запустите в любом удобном режиме:**
```
make run
```
```
make run-dev
```
```
make run-prod
```
```
make run-agent
```
```
make run-orchestrator
```
```
make run-race
```

## Метод 3: использование PowerShell

**Соберите службу PoweShell:**
```
.\build.ps1
```
**Запустите в любом удобном режиме:**
```
run
```
```
run-dev
```
```
run-prod
```

## Метод 4: использование CMD

**Собрать проект:**
```
go build -o bin/orchestrator.exe cmd/orchestrator/main.go
```
```
go build -o bin/agent.exe cmd/agent/main.go
```
**Запустите сервисы:**
```
bin\orchestrator.exe
```
```
bin\agent.exe
```


## Переменные среды

### Служба оркестратора:

1. `PORT` - HTTP порт сервера (по умолчанию: 8080)
2. `TIME_ADDITION_MS` - Время выполнения операции сложения (по умолчанию: 100)
3. `TIME_SUBTRACTION_MS` - Время выполнения операции вычитания (по умолчанию: 100)
4. `TIME_MULTIPLY_MS` - Время выполнения операции умножения (по умолчанию: 200)
5. `TIME_DIVISION_MS` - Время выполнения операции деления (по умолчанию: 200)

### Агентская служба:

1. `COMPUTING_POWER` - Количество одновременных вычислений (по умолчанию: 1)
2. `ORCHESTRATOR_URL` - URL-адрес службы оркестратора (по умолчанию: http://localhost:8080)

## API эндпоинты

### Служба оркестратора:

- `POST /api/v1/calculate` - Отправить выражение для вычисления
- `GET /api/v1/expressions` - Список всех выражений
- `GET /api/v1/expressions/{id}` - Получить статус и результат выражения

### Внутренний API

- `GET /internal/task` - Получить следующую задачу (используется агентами)
- `POST /internal/task` - Отправить результат задачи (используется агентами)

## Примеры использования

### Успешное вычисление

**Используя curl запрос:**
```
curl -L 'http://localhost:8080/api/v1/calculate' -H 'Content-Type: application/json' --data '{"expression":"2+2*2"}'
```
**Ответ (HTTP 201 Created):**
```json

{

    "id": "123e4567-e89b-12d3-a456-426614174000"

}

```
**Проверка решения примера:**
```
curl --location 'http://localhost:8080/api/v1/expressions/123e4567-e89b-12d3-a456-426614174000'
```
**Ответ (HTTP 200 OK):**
```json

{

    "expression": {

        "id": "123e4567-e89b-12d3-a456-426614174000",

        "expression": "2+2*2",

        "status": "COMPLETE",

        "result": 6

    }

}

```

### Неуспешное вычисление

**Пустое выражение:**
```
curl -L 'http://localhost:8080/api/v1/calculate' -H 'Content-Type: application/json' --data '{"expression":""}'
```
**Ответ (HTTP 422 Unprocessable Entity):**
```json

{

    "error": "Expression cannot be empty"

}

```

**Неверный формат выражения:**
```
curl -L 'http://localhost:8080/api/v1/calculate' -H 'Content-Type: application/json' --data '{"expression":"2++2"}'
```
**Ответ (HTTP 201 Created, но проверьте статус):**
```json

{

    "expression": {

        "id": "123e4567-e89b-12d3-a456-426614174000",

        "expression": "2++2",

        "status": "ERROR",

        "error": "invalid expression: too few tokens"

    }

}

```

**Выражение не найдено:**
```
curl --location 'http://localhost:8080/api/v1/expressions/non-existent-id'
```
Ответ (HTTP 404 Not Found):
```json

{

    "error": "Expression not found"

}

```

### Список всех выражений

**Ввод:**
```
curl --location 'http://localhost:8080/api/v1/expressions'
```
**Ответ (HTTP 200 OK):**
```json

{

    "expressions": [

        {

            "id": "123e4567-e89b-12d3-a456-426614174000",

            "expression": "2+2*2",

            "status": "COMPLETE",

            "result": 6

        },

        {

            "id": "987fcdeb-51d3-12a4-b678-426614174000",

            "expression": "10-5",

            "status": "COMPLETE",

            "result": 5

        }

    ]

}

```

### Postman

Вы можете использовать Postman для проверки проекта:
![[Pasted image 20250221114952.png]]
### Тестирование

**Для запуска тестов выполните:**
```
go test ./...
```
**Для подробного вывода тестов:**
```
go test ./... -v
```

